---
- name: Configure Lima VMs
  hosts: "{{ target_cluster | default('demo-k8s') }}_all"
  gather_facts: yes
  become: yes
  
  vars_files:
    - "../../{{ config_file | default('vars/cluster_config.yml') }}"
  
  tasks:
    - name: Update package cache
      ansible.builtin.package:
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Install required packages
      ansible.builtin.package:
        name:
          - xfsprogs
          - parted
          - net-tools
          - vim
          - bc
          - lsof
        state: present
    
    - name: Configure additional disks (bare-metal only)
      ansible.builtin.include_tasks: ../../tasks/configure_disks.yml
      loop: "{{ additional_disks | default([]) }}"
      loop_control:
        loop_var: disk_item
      when: 
        - deployment.type == "baremetal"
        - additional_disks is defined 
        - additional_disks | length > 0
    
    - name: Create directories for MinIO data (bare-metal only)
      ansible.builtin.file:
        path: "/mnt/{{ item.name }}/minio"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop: "{{ additional_disks | default([]) }}"
      when: 
        - deployment.type == "baremetal"
        - additional_disks is defined
        - additional_disks | length > 0
        - "'data' in item.name"
    
    - name: Display disk configuration status
      ansible.builtin.debug:
        msg: >-
          {% if deployment.type == "baremetal" %}
          Configured {{ additional_disks | default([]) | length }} additional disk(s) on {{ inventory_hostname }} (bare-metal mode)
          {% else %}
          Skipped disk configuration on {{ inventory_hostname }} ({{ deployment.type }} mode - disks left raw for DirectPV)
          {% endif %}