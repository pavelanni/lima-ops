---
# Main tasks for lima_disks role
# Handles disk detection, partitioning, formatting, and mounting

# Parse additional_disks from JSON string if needed (inventory stores it as string)
- name: Parse additional_disks from JSON string
  ansible.builtin.set_fact:
    parsed_disks: "{{ additional_disks | from_json }}"
  when:
    - additional_disks is defined
    - additional_disks is string
    - additional_disks | length > 0

- name: Use additional_disks directly if already a list
  ansible.builtin.set_fact:
    parsed_disks: "{{ additional_disks }}"
  when:
    - additional_disks is defined
    - additional_disks is not string

- name: Set empty list if additional_disks not defined
  ansible.builtin.set_fact:
    parsed_disks: []
  when: additional_disks is not defined

# Clean up any legacy mounts before configuring from inventory
- name: Clean up legacy mount points
  ansible.builtin.include_tasks: cleanup_legacy_mounts.yml
  when: parsed_disks | length > 0

- name: Configure disks from inventory
  ansible.builtin.include_tasks: configure_from_inventory.yml
  when: parsed_disks | length > 0

- name: Auto-detect and configure disks
  ansible.builtin.include_tasks: auto_detect.yml
  when: parsed_disks | length == 0
