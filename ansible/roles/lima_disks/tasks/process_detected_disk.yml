---
# Process a single detected disk
# Handles unmounting, partitioning, formatting, mounting, and fstab management

- name: Check for existing partitions on disk
  ansible.builtin.shell: lsblk -n -o NAME /dev/{{ disk.name }} | tail -n +2
  register: existing_partitions
  changed_when: false
  failed_when: false

- name: Unmount any existing partitions
  ansible.builtin.mount:
    path: "{{ item }}"
    state: unmounted
  loop: "{{ ansible_mounts | selectattr('device', 'match', '/dev/' + disk.name + '.*') | map(attribute='mount') | list }}"
  when: ansible_mounts | selectattr('device', 'match', '/dev/' + disk.name + '.*') | list | length > 0

- name: Remove fstab entries for this disk
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: "^[^#]*{{ disk.name }}.*"
    state: absent
    backup: true

- name: Wipe existing filesystem signatures
  ansible.builtin.shell: wipefs -a /dev/{{ disk.name }}
  register: wipefs_result
  changed_when: wipefs_result.stdout != ""
  failed_when: false

- name: Process disk formatting and mounting
  block:
    - name: Create GPT partition table
      ansible.builtin.shell: |
        parted -s /dev/{{ disk.name }} mklabel gpt
        parted -s /dev/{{ disk.name }} mkpart primary 0% 100%
      register: partition_result
      changed_when: true

    - name: Wait for partition to be created
      ansible.builtin.pause:
        seconds: 2

    - name: Format partition with {{ disk_filesystem | upper }}
      ansible.builtin.filesystem:
        fstype: "{{ disk_filesystem }}"
        dev: "/dev/{{ disk.name }}1"
        force: true
      register: format_result

    - name: Get filesystem UUID
      ansible.builtin.shell: blkid -s UUID -o value /dev/{{ disk.name }}1
      register: fs_uuid
      changed_when: false

    - name: Create mount point
      ansible.builtin.file:
        path: "{{ mount_base }}/minio{{ disk_index + 1 }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Add to fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "UUID={{ fs_uuid.stdout }} {{ mount_base }}/minio{{ disk_index + 1 }} {{ disk_filesystem }} defaults 0 2"
        backup: true
        create: true

    - name: Mount filesystem
      ansible.builtin.mount:
        path: "{{ mount_base }}/minio{{ disk_index + 1 }}"
        src: "UUID={{ fs_uuid.stdout }}"
        fstype: "{{ disk_filesystem }}"
        state: mounted

    - name: Display mount success
      ansible.builtin.debug:
        msg: "Successfully mounted {{ disk.name }} to {{ mount_base }}/minio{{ disk_index + 1 }} (UUID: {{ fs_uuid.stdout }})"
